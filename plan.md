🚀 Project: 어그로필터 (AggroFilter) - Phase 1 Plan
Last Updated: 2026-02-14 23:25 KST

## 1. 서비스 개요 (Overview)
### 1.1 목표 (Goal)
유튜브 영상의 과장/낚시 여부를 분석하여 신뢰도 랭킹을 제공하고, 사용자에게 **건전한 채널을 추천(Navigation)**한다.

### 1.2 아키텍처: App Shell 구조
향후 쇼핑/뉴스 확장을 고려하여 확장 가능한 구조로 설계됨.
- **App Shell**: 공통 헤더, 라우팅, i18n 관리.
- **Current Module**: YouTube Module (`/youtube/*`) - 핵심 개발 범위.
- **Hybrid Strategy**: PC(확장프로그램) + Mobile(WebView App) 투트랙 전략.

---

## 2. 유튜브 모듈 핵심 로직 (Functional Logic)
### 2.1 데이터 수집 전략 (Data Acquisition)
서버 IP 차단을 피하고 분석 품질을 확보하기 위해 클라이언트 사이드 추출을 원칙으로 함.

#### [PC] Chrome 확장프로그램
- **특징**: 최상위 분석 품질. 유튜브 UI와 완전 동기화.
- **역할**: 자막(CC), 메타데이터(조회수, 카테고리 등) 직접 추출 후 서버 전송.

#### [Mobile] 전용 WebView 앱 (Hybrid App)
- **방식**: 앱 내 WebView로 유튜브 로드 -> JS Injection -> DOM/API Intercept.
- **동의 기반 온보딩**: 사용자의 "콘텐츠 로드 및 자막 분석 동의"를 필수 전제로 함.
- **기술적 한계 인정**: 유튜브의 모바일 웹 대응에 따라 품질이 100% 보장되지 않을 수 있음을 UX로 명시 (예: "정밀 분석 가능 여부 확인 중...").

#### [Future] 온디바이스(On-device) 분석 검토
- **개념**: 서버 부하 및 프라이버시 고려, 자막 요약 등 가벼운 로직을 클라이언트(브라우저/앱) 내 AI 모델로 처리 시도.

---

### 2.2 유튜브 분류 및 랭킹 (Classification & Ranking)
- **분류 전략: "Youtube Native"**: 유튜브 공식 `category_id` (1~29) 사용.
- **글로벌 랭킹 키**: `[Language] + [Country] + [Category ID]` (DB 반영 완료: 2026-01-20).

### 2.2 점수 산정 가이드 (Fact-Based Gap Analysis) 🎯
'제목/썸네일이 약속한 내용'과 '실제 영상 내용' 사이의 **불일치(Gap)** 정도를 기준으로 산정함.

| 점수 | 단계 | 기준 (The Gap Scale) |
| :--- | :--- | :--- |
| **0~20점** | 일치/Marketing | [Gap 없음] 제목이 자극적이어도 내용이 사실이면 OK. |
| **21~40점** | 과장/Exaggerated | [시간적 피해] 작은 사실 침소봉대. |
| **41~60점** | 왜곡/Distorted | [정신적 피해] 문맥 비틀기, 혐오 조장. |
| **61~100점** | 허위/Fabricated | [금전적/실질적 피해] 없는 사실 날조, 사기. |

**매핑 로직 (Accuracy Cap):**
- 🟢 **Green (Clean)**: 정확도 70점 이상 → 어그로 점수 0~50점
- 🟡 **Yellow (Caution)**: 정확도 40~69점 → 어그로 점수 0~70점
- 🔴 **Red (Warning)**: 정확도 0~39점 → 어그로 점수 0~100점

---

## 3. 기술 스택 및 데이터 수집 (Tech Spec)
### 3.1 AI Engine
- **Model**: `gemini-2.0-flash-exp` (또는 `gemini-2.5-flash-preview-09-2025` 사용 가능 시 업데이트)
- **Why**: 속도와 가성비 최적화.
- **SDK**: Google Generative AI SDK (Paid Tier Key 필수).

### 3.2 데이터 수집 (Client-side Fetching) ⚠️
서버 IP 차단을 피하기 위해, 서버는 유튜브에 직접 접속하지 않음.
- **PC**: Chrome 확장프로그램이 추출한 데이터를 수신.
- **Mobile**: 앱 내부 WebView의 네트워크 패킷을 Intercept하여 데이터를 수신.

---

## 4. 인증 및 글로벌 (Common)
- **인증 (Authentication)**: Google OAuth 기반. 확장프로그램 연동성을 위해 구글 로그인 기본 적용 (이메일 인증 생략).
- **글로벌 (i18n)**: `navigator.language` 기반 자동 감지. UI 텍스트 및 카테고리 명칭 대응.

---

## 5. 핵심 미션 (Current Missions)
1.  **AI 분석 로직 고도화**: `lib/gemini.ts`에 이미 반영된 최신 프롬프트 기준 분석 로직 유지 및 고도화.
2.  **DB 스키마 정교화**: `t_channels`에 `f_language`, `f_country` 추가 완료. 이를 활용한 랭킹 쿼리 작성.
3.  **Client-Server 데이터 연동**: 확장프로그램/WebView로부터 전달받은 `transcript`와 `meta_data`를 처리하는 API 엔드포인트 구현 (확장프로그램에서 유튜브 API를 통해 메타데이터 선취득 구조 고려).
4.  **랭킹 시스템 구현**: 카테고리별/국가별 실시간 랭킹 산출 로직 구현.

---

## 🧠 Appendix: AI System Prompt
```javascript
const systemPrompt = `
    # 어그로필터 분석 AI용 프롬프트 (유튜브 생태계 분석가 모드)
    
    ## 역할
    너는 엄격한 팩트체커가 아니라, **'유튜브 생태계 분석가'**다. 
    유튜브 특유의 표현 방식을 이해하되, 시청자가 실제로 **"속았다"**고 느끼는지 여부를 핵심 기준으로 점수를 매겨라.
    
    ## 분석 및 채점 기준 (Scoring Rubric)
    0점(Clean)에서 100점(Aggro) 사이로 어그로 점수를 매길 때, 아래 기준을 엄격히 따라라.
    
    1. 정확성 점수 (Accuracy Score) - **[선행 평가]**
    - 영상 본문 내용이 팩트에 얼마나 충실한지, 정보로서의 가치가 있는지 0~100점으로 먼저 평가하라.

    2. 어그로 지수 (Clickbait Score) - **[Fact-Based Gap Analysis]** 🎯
    - **핵심 원칙**: 어그로 점수는 단순한 '표현의 자극성'이 아니라, '제목/썸네일이 약속한 내용'과 '실제 영상 내용' 사이의 **불일치(Gap)** 정도를 기준으로 산정한다.

    - **상세 점수 기준 (The Gap Scale)**:
        - **0~20점 (일치/Marketing)**: [Gap 없음 - 피해 없음] 제목이 자극적이어도 내용이 이를 충분히 뒷받침함. (유튜브 문법상 허용되는 마케팅)
        - **21~40점 (과장/Exaggerated)**: [시간적 피해 (Time Loss)] 작은 사실을 침소봉대하여 시청자의 시간을 낭비하게 함. 핵심 팩트는 있으나 부풀려짐.
        - **41~60점 (왜곡/Distorted)**: [정신적 피해 (Mental Fatigue)] 문맥을 비틀거나 엉뚱한 결론을 내어 시청자에게 혼란과 짜증 유발. 정보 가치 낮음.
        - **61~100점 (허위/Fabricated)**: [실질적 피해 (Loss)] 없는 사실 날조, 사기성 정보. 심각한 오해나 실질적 손실 초래 가능.

    **[논리 일치성 절대 준수]**
    - 자극적인 표현('미쳤다', '방금 터졌다' 등)이 있더라도 내용이 사실이면 어그로 점수를 낮게 책정하라.
    - 텍스트 평가와 수치(점수)의 논리적 일관성을 반드시 유지하라.
    
    3. 신뢰도 계산식
    - **신뢰도**: (정확성 + (100 - 어그로 지수)) / 2
    
    ## 분석 지침 (Critical Instructions)
    1. **수치 데이터 분석 정확도**: 억, 만 등 단위가 포함된 숫자를 철저히 계산하라. 예: 282억 원은 '수백억'대이지 '수십억'대가 아니다. 단위 혼동으로 인한 오판을 절대 하지 마라.
    2. **내부 로직 보안**: 분석 사유 작성 시 "정확도 점수가 70점 이상이므로 어그로 점수를 낮게 책정한다"와 같은 **시스템 내부 채점 규칙이나 로직을 시청자에게 직접 언급하지 마라.** 시청자에게는 오직 영상의 내용과 제목 간의 관계를 바탕으로 한 결과론적 사유만 설명하라.
    
    ## 출력 형식 (JSON Only)
    반드시 아래 JSON 형식으로만 응답하라. 다른 텍스트는 포함하지 말 것.
    - **중요**: subtitleSummary에는 절대 <br /> 등 어떤 HTML 태그도 사용하지 마라. 오직 '0:00 - 내용' 형식의 순수 텍스트만 사용하라. 줄바꿈은 \n 문자만 사용하라.
    - **중요**: evaluationReason 내에서만 문단을 구분할 때 <br /><br /> 태그를 사용하여 강제로 줄바꿈을 표현하라.
    
    {
      "accuracy": 0-100 (정수),
      "clickbait": 0-100 (정수),
      "reliability": 0-100 (정수),
      "subtitleSummary": "0:00 - 소주제: 요약내용\n... (반드시 영상 종료 시점까지 포함)",
      "evaluationReason": "1. 내용 정확성 검증 (XX점):<br />내용...<br /><br />2. 어그로성 평가 (XX점):<br />내용...<br /><br />3. 신뢰도 총평 (XX점 / 🟢Green):<br />내용...",
      "overallAssessment": "전반적인 평가 및 시청자 유의사항",
      "recommendedTitle": "어그로성 30% 이상일 때만 추천 제목 (아니면 빈 문자열)"
    }
    `;

## 6. 실행 로드맵 (Roadmap)

### Step 1: 구조 잡기 ✅ 완료
- App Shell (헤더, 라우팅) 구현.
- DB 스키마 (t_videos, t_channels)에 언어/국가 필드 적용.

### Step 2: 분석 엔진 완성 ✅ 완료
- Gemini 2.5 Flash 연동 및 프롬프트 최적화.
- 클라이언트(확장팩/앱)에서 자막 받아오는 API 연동.

### Step 3: 랭킹 시스템 ✅ 완료
- 랭킹 산정 쿼리 및 캐싱 시스템 구현.
- 랭킹 UI (무한 스크롤, 내 순위 스티키 바, Top 3 명예의 전당) 구현.

### Step 4: 알림 시스템 ✅ 완료 (트리거 연결 제외)
- 알림 발송 API (등급변화, 랭킹변동, 상위10%) 구현.
- 알림 페이지 UI (목록, 읽음처리, 타입별 아이콘, 모두읽음) 구현.
- 모닝 리포트 cron API 구현.

### Step 5: 결제 시스템 (카페24) 🔧 코드 완성, 세팅 필요
- OAuth 인증 플로우, Webhook 수신, 크레딧 충전 로직 구현 완료.
- 카페24 쇼핑몰 세팅 (앱 설치, 상품 등록, Webhook URL 등록) 필요.
- Mock 결제 → 실결제 전환 필요.

### Step 6: 관리자 (Admin) ✅ 완료
- 통계, 분석 로그 (삭제 기능 포함), 크레딧 관리, 결제 로그 탭 구현.

## 7. 알림 시스템 (Notification System)
### 7.1 채널 구독 및 알림 메커니즘
- **자동 구독**: 사용자가 영상을 분석하면 해당 채널을 자동으로 구독 처리
- **알림 조건**: 구독 채널의 상태 변화 시 이메일 알림 발송
- **알림 설정**: 사용자가 마이페이지에서 알림 활성화/비활성화 가능

### 7.2 알림 발송 조건
#### 1. 신뢰도 그레이드 변화 알림 (우선순위: 높음)
- **조건**: 채널의 신뢰도 그레이드가 변경될 때 (Red ↔ Yellow ↔ Blue)
- **그레이드 기준**:
  - 🔵 Blue Zone: 신뢰도 70점 이상
  - 🟡 Yellow Zone: 신뢰도 40~69점
  - 🔴 Red Zone: 신뢰도 39점 이하
- **알림 내용**: 카테고리, 채널명, 기존 등급 표시 (변화값은 표시하지 않음)
- **목적**: 신뢰하던 채널의 품질 변화를 즉시 감지

#### 2. 상위 10% 진입/탈락 알림 (우선순위: 중간)
- **조건**: 구독 채널이 카테고리 상위 10%에 진입하거나 탈락할 때
- **계산 방식**: 카테고리 전체 채널 수 × 0.1 (올림)
- **알림 내용**: 진입/탈락 상태, 카테고리 정보
- **목적**: 구독 채널의 성과 변화 추적

### 7.3 구독 관리 기능
- **위치**: 마이페이지 > 나의 채널 탭
- **UI**: '구독 관리' 버튼 클릭 시 관리 모드 활성화
- **기능**:
  - 좌측 체크박스로 채널 선택
  - 전체 선택/해제 (헤더 체크박스)
  - 선택 삭제 버튼 (하단)
- **API**: `/api/subscription/unsubscribe` - 선택한 채널 구독 해제

### 7.4 구현 완료 항목
- `t_channel_subscriptions` 테이블: 구독 정보 및 이전 상태 추적 (상위 10% 상태 포함)
- `lib/notification.ts`: 자동 구독 및 변화 감지 로직 (상위 10% 계산)
- `/api/notification/send-grade-change`: 그레이드 변화 알림 API
- `/api/notification/send-ranking-change`: 랭킹 변동 알림 API
- `/api/notification/send-top10-change`: 상위 10% 변화 알림 API
- `/api/notification/list`: 알림 목록 조회 + 읽음 처리 API
- `/api/notification/unread-count`: 미읽음 개수 API
- `/api/subscription/unsubscribe`: 구독 해제 API
- `/api/cron/send-morning-reports`: 모닝 리포트 생성 API
- 마이페이지 구독 관리 UI (체크박스 선택 삭제)
- 알림 페이지 UI (목록, 읽음처리, 타입별 아이콘/색상, 모두읽음 버튼)
- 알림 클릭 시 채널 통합 리포트(`/channel/[id]`)로 이동

### 7.5 향후 추가 예정
- **구독 채널 리포트**: 마이페이지 내 상시 확인 가능한 대시보드 기능
- **알림 빈도 설정**: 즉시/일일 요약/주간 요약 옵션 제공
- **알림 세부 설정**: 마이페이지 > 알림 설정에서 일괄 관리

---

## 8. 카페24 결제 시스템 (Payment via Cafe24)

### 8.1 구현 완료 (코드)
- **OAuth 인증**: `api/cafe24/oauth/start` → `callback` → 토큰 저장/갱신 (`lib/cafe24.ts`)
- **Webhook 수신**: `api/cafe24/webhook` — 주문완료 이벤트 수신, 중복 방지, 결제 상태 검증
- **크레딧 충전**: 주문 데이터에서 이메일 추출 → 상품→크레딧 매핑 → `t_users.f_recheck_credits` 업데이트
- **미매칭 결제**: 유저 못 찾으면 `t_unclaimed_payments`에 로깅
- **Mock 결제**: `payment/mock/page.tsx` — 테스트용 결제 페이지

### 8.2 남은 세팅 작업
1. **환경변수 등록** (Vercel): `CAFE24_MALL_ID`, `CAFE24_CLIENT_ID`, `CAFE24_CLIENT_SECRET`, `CAFE24_REDIRECT_URI`, `CAFE24_OAUTH_SCOPE`, `CAFE24_WEBHOOK_SECRET`, `CAFE24_CREDIT_PRODUCT_MAP`
2. **카페24 앱 설치**: 쇼핑몰에서 앱 설치 후 `/api/cafe24/oauth/start` 1회 호출하여 토큰 발급
3. **Webhook URL 등록**: 카페24 개발자센터 → 주문완료 이벤트 → `https://도메인/api/cafe24/webhook?secret=xxx`
4. **크레딧 상품 등록**: 카페24 쇼핑몰에 1/5/10 크레딧 상품 등록 → `CAFE24_CREDIT_PRODUCT_MAP` JSON 매핑
5. **Mock → 실결제 전환**: 채널리포트 "충전" 버튼 → 카페24 쇼핑몰 결제 URL로 변경

---

## 9. 마케팅 자동화 (Marketing Automation) — Phase 2

> **전제**: 11장 TODO 항목 전부 완료 후 착수.

### 9.1 구축 예정 항목
- **SEO 자동화**: 사이트맵 생성, 구조화 데이터(JSON-LD), OG 메타태그 동적 생성
- **소셜 공유 최적화**: 분석 결과 카드 이미지 자동 생성 (OG Image), 공유 URL 단축
- **이메일 마케팅**: 신규 가입 웰컴 메일, 비활성 유저 리텐션 메일, 주간 다이제스트
- **리퍼럴 시스템**: 초대 링크 생성, 초대 보상 크레딧 지급
- **랜딩 페이지**: 서비스 소개 + CTA (분석 체험) 페이지
- **UTM 트래킹**: 유입 경로별 전환율 추적 (GA4 연동)
- **푸시 알림**: 웹 푸시 (Service Worker) 또는 앱 푸시
- **콘텐츠 마케팅**: 블로그/뉴스레터 자동 발행 (인기 채널 분석 리포트 등)

### 9.2 우선순위 (예정)
1. 랜딩 페이지 + SEO 기본 세팅
2. 이메일 마케팅 (웰컴 + 주간 다이제스트)
3. 소셜 공유 카드 이미지 자동 생성
4. 리퍼럴 시스템
5. 푸시 알림

---

## 10. 향후 논의 사항 (Backlog)
- **확장프로그램 별도 구축 (Mission 4)**: 현재 앱 서비스 완성 후, 데이터 수집 효율화를 위한 전용 확장프로그램 개발 논의 예정.

Instruction for Developer:
현재는 **Phase 1 (유튜브)**에만 집중하십시오.
쇼핑이나 뉴스 관련 로직은 구조상 자리를 비워두되, 실제 구현은 하지 마십시오.
모든 로직은 functional_logic_guide.md에 정의된 내용을 따르십시오.

---

## 11. 최근 주요 업데이트 (Recent Updates)

### 11.1 2026-02-14 업데이트
- **알림 페이지 구현**: placeholder → 실제 알림 목록 표시 (타입별 아이콘/색상, 읽음처리, 모두읽음)
- **알림 클릭 → 채널 통합 리포트**: 알림 링크를 `/p-ranking` → `/channel/[id]`로 변경
- **마이페이지 탭 상태 유지**: URL 파라미터 기반 탭 상태 관리, 뒤로가기 시 데이터 재로드
- **Admin 분석 로그 관리**: 삭제 기능, 비로그인 사용자 표시, 채널명 컬럼 추가

### 11.2 2026-02-03 업데이트
- **Top 3 명예의 전당 UI**: 카테고리별 랭킹 상단 1/2/3위 시각 강조
- **'내 순위로 이동' 호환성 확보**: Top 3 내 순위도 정상 스크롤
- **채널 재분석 모달 UX 개선**
- **Mock 결제 페이지 문구 수정**

---

## 12. 남은 할 일 (TODO)

### HIGH — 수익화 & 핵심 기능
| # | 항목 | 상태 |
|---|------|------|
| 1 | 카페24 환경변수 세팅 (Vercel) | 대기 |
| 2 | 카페24 앱 설치 → OAuth 토큰 발급 | 대기 |
| 3 | 카페24 Webhook URL 등록 | 대기 |
| 4 | 크레딧 상품 등록 + CREDIT_PRODUCT_MAP 매핑 | 대기 |
| 5 | Mock → 실결제 전환 (충전 버튼 URL 변경) | 대기 |
| 6 | 알림 트리거 연결 (분석 완료 → checkRankingChangesAndNotify 호출) | 대기 |

### MEDIUM — 품질 & 운영
| # | 항목 | 상태 |
|---|------|------|
| 7 | 결제 완료 후 앱 복귀 흐름 확인 (webhook 비동기 특성) | 대기 |
| 8 | Admin: 미매칭 결제(t_unclaimed_payments) 관리 UI | 대기 |
| 9 | t_payment_logs에 실제 결제 기록 저장 | 대기 |
| 10 | 알림 설정 토글 → 서버(f_notification_enabled) 동기화 | 대기 |
| 11 | 모닝 리포트 Vercel Cron 설정 | 대기 |
| 12 | Resend 커스텀 도메인 설정 (스팸 방지) | 대기 |
| 13 | f_user_id email vs UUID 전수 검사 → 일관성 확보 | 대기 |
| 14 | 비로그인 분석 데이터 정리 정책 수립 | 대기 |
| 15 | Admin 통계: 고유 분석 사용자 수 표시 | 대기 |
| 16 | 모바일 반응형 최종 점검 | 대기 |

### LOW — 개선 & 스케일
| # | 항목 | 상태 |
|---|------|------|
| 17 | 이메일 내 CTA 링크 /channel/[id]로 변경 | 대기 |
| 18 | SEO / OG 메타태그 점검 | 대기 |
| 19 | 에러 핸들링 강화 (토스트 등) | 대기 |
| 20 | 플라자 정렬/필터 개선 | 대기 |
| 21 | f_rank 컬럼 마이그레이션 (스케일 대비) | 대기 |