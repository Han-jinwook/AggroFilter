<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AggroFilter AutoMarketer ëŒ€ì‹œë³´ë“œ</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #0f1117; color: #e2e8f0; min-height: 100vh; }

    header {
      background: #1a1d2e;
      border-bottom: 1px solid #2d3748;
      padding: 16px 28px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header h1 { font-size: 18px; font-weight: 700; color: #fff; }
    header .badge {
      font-size: 11px; padding: 3px 10px; border-radius: 20px;
      background: #2d3748; color: #a0aec0;
    }
    header .badge.running { background: #276749; color: #9ae6b4; }

    .container { max-width: 1200px; margin: 0 auto; padding: 24px 20px; }

    .grid { display: grid; grid-template-columns: 340px 1fr; gap: 20px; }

    .panel {
      background: #1a1d2e;
      border: 1px solid #2d3748;
      border-radius: 10px;
      padding: 20px;
    }
    .panel h2 { font-size: 13px; font-weight: 600; color: #a0aec0; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 16px; }

    .status-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #2d3748; font-size: 13px; }
    .status-row:last-child { border-bottom: none; }
    .status-row label { color: #a0aec0; }
    .status-row span { color: #e2e8f0; font-weight: 500; }

    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; font-size: 12px; color: #a0aec0; margin-bottom: 6px; }
    .form-group input {
      width: 100%; padding: 8px 10px;
      background: #0f1117; border: 1px solid #2d3748;
      border-radius: 6px; color: #e2e8f0; font-size: 14px;
    }
    .form-group input:focus { outline: none; border-color: #4299e1; }
    .form-group .hint { font-size: 11px; color: #718096; margin-top: 4px; }

    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 9px 16px; border-radius: 7px; font-size: 13px;
      font-weight: 600; cursor: pointer; border: none; transition: opacity .15s;
    }
    .btn:hover { opacity: .85; }
    .btn:disabled { opacity: .4; cursor: not-allowed; }
    .btn-primary { background: #3182ce; color: #fff; }
    .btn-success { background: #276749; color: #9ae6b4; }
    .btn-danger  { background: #742a2a; color: #fc8181; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    .btn-row { display: flex; gap: 8px; margin-top: 8px; }

    .schedule-info {
      background: #2d3748; border-radius: 8px; padding: 12px;
      font-size: 12px; color: #a0aec0; margin-bottom: 16px; line-height: 1.7;
    }
    .schedule-info strong { color: #63b3ed; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 8px 10px; background: #0f1117; color: #718096; font-weight: 500; font-size: 11px; text-transform: uppercase; }
    td { padding: 9px 10px; border-bottom: 1px solid #1e2335; }
    tr:hover td { background: #1e2335; }

    .score { display: inline-block; padding: 2px 8px; border-radius: 4px; font-weight: 600; font-size: 12px; }
    .score-high   { background: #276749; color: #9ae6b4; }
    .score-mid    { background: #744210; color: #fbd38d; }
    .score-low    { background: #742a2a; color: #fc8181; }

    .track-badge {
      font-size: 10px; padding: 2px 6px; border-radius: 3px; font-weight: 600;
    }
    .track-type1 { background: #2b4c7e; color: #90cdf4; }
    .track-type2 { background: #2d3a2e; color: #9ae6b4; }

    .title-cell { max-width: 340px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .title-cell a { color: #63b3ed; text-decoration: none; }
    .title-cell a:hover { text-decoration: underline; }

    .empty { text-align: center; padding: 48px 0; color: #4a5568; font-size: 14px; }

    .toast {
      position: fixed; bottom: 24px; right: 24px;
      background: #2d3748; border: 1px solid #4a5568;
      border-radius: 8px; padding: 12px 18px;
      font-size: 13px; color: #e2e8f0;
      box-shadow: 0 4px 20px rgba(0,0,0,.5);
      opacity: 0; transition: opacity .2s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; }
    .toast.ok { border-color: #276749; color: #9ae6b4; }
    .toast.err { border-color: #742a2a; color: #fc8181; }

    .section-divider { height: 1px; background: #2d3748; margin: 20px 0; }
  </style>
</head>
<body>

<header>
  <h1>ğŸ¤– AggroFilter AutoMarketer</h1>
  <span class="badge" id="headerBadge">ë¡œë”© ì¤‘...</span>
</header>

<div class="container">
  <div class="grid">

    <!-- ì¢Œì¸¡: ì œì–´íŒ -->
    <div>
      <!-- ë´‡ ìƒíƒœ -->
      <div class="panel" style="margin-bottom:16px">
        <h2>ë´‡ ìƒíƒœ</h2>
        <div class="status-row">
          <label>í˜„ì¬ ìƒíƒœ</label>
          <span id="statusText">â€”</span>
        </div>
        <div class="status-row">
          <label>ë§ˆì§€ë§‰ ì‹¤í–‰</label>
          <span id="lastRun">â€”</span>
        </div>
        <div class="status-row">
          <label>ë§ˆì§€ë§‰ ê²°ê³¼</label>
          <span id="lastResult">â€”</span>
        </div>

        <div class="section-divider"></div>

        <div class="schedule-info">
          <strong>ìë™ ìŠ¤ì¼€ì¤„</strong><br>
          ë§¤ì¼ ì˜¤ì „ 6:00 / ì˜¤í›„ 6:00 (KST) ìë™ ì‹¤í–‰<br>
          <strong>ìˆ˜ë™ ì‹¤í–‰:</strong> ì§€ê¸ˆ ì¦‰ì‹œ 1íšŒ ìˆ˜ì§‘ + ë¶„ì„
        </div>

        <div class="btn-row">
          <button class="btn btn-success" id="btnRun" onclick="runNow()">â–¶ ì§€ê¸ˆ ì‹¤í–‰</button>
        </div>
      </div>

      <!-- ìˆ˜ì§‘ ì˜µì…˜ -->
      <div class="panel">
        <h2>ìˆ˜ì§‘ ì˜µì…˜ (N / M / X)</h2>

        <div class="form-group">
          <label>N â€” ì „ì²´ íŠ¸ë Œë“œ ìˆ˜ì§‘ ê°œìˆ˜ (Type1)</label>
          <input type="number" id="optN" min="1" max="50" />
          <div class="hint">YouTube ì „ì²´ ì¸ê¸° ìˆœìœ„ ìƒìœ„ Nê°œ ìˆ˜ì§‘</div>
        </div>

        <div class="form-group">
          <label>M â€” ì¹´í…Œê³ ë¦¬ë³„ ìˆ˜ì§‘ ê°œìˆ˜ (Type2)</label>
          <input type="number" id="optM" min="1" max="20" />
          <div class="hint">7ê°œ ì¹´í…Œê³ ë¦¬ Ã— Mê°œ = ìµœëŒ€ MÃ—7ê°œ ì¶”ê°€ ìˆ˜ì§‘</div>
        </div>

        <div class="form-group">
          <label>X â€” ì±„ë„ ì¿¨íƒ€ì„ (ì¼)</label>
          <input type="number" id="optX" min="1" max="30" />
          <div class="hint">ìµœê·¼ Xì¼ ì´ë‚´ ë¶„ì„ëœ ì±„ë„ì€ ìŠ¤í‚µ (ë‹¤ì–‘ì„± í™•ë³´)</div>
        </div>

        <div class="form-group">
          <label>ë¶„ì„ ë”œë ˆì´ (ms)</label>
          <input type="number" id="optDelay" min="1000" step="1000" />
          <div class="hint">API Rate Limit ë°©ì–´ìš© ìš”ì²­ ê°„ê²©</div>
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" onclick="saveOptions()">ğŸ’¾ ì €ì¥</button>
        </div>
      </div>
    </div>

    <!-- ìš°ì¸¡: ìˆ˜ì§‘ ë¦¬ìŠ¤íŠ¸ -->
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="margin-bottom:0">ëˆ„ì  ìˆ˜ì§‘ ë¦¬ìŠ¤íŠ¸ (ë´‡ ë¶„ì„ ì˜ìƒ)</h2>
        <button class="btn btn-sm btn-primary" onclick="loadCollected()">â†» ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <div id="tableWrap">
        <div class="empty">ë¡œë”© ì¤‘...</div>
      </div>
    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  let pollingTimer = null;

  async function fetchStatus() {
    try {
      const res = await fetch('/api/status');
      const { status, options } = await res.json();

      // í—¤ë” ë°°ì§€
      const badge = document.getElementById('headerBadge');
      if (status.running) {
        badge.textContent = 'ğŸ”„ ì‹¤í–‰ ì¤‘';
        badge.className = 'badge running';
      } else {
        badge.textContent = 'ğŸŸ¢ Auto ëª¨ë“œ ëŒ€ê¸°';
        badge.className = 'badge';
      }

      document.getElementById('statusText').textContent = status.running ? 'ğŸ”„ ë¶„ì„ ì§„í–‰ ì¤‘...' : 'ëŒ€ê¸° ì¤‘';
      document.getElementById('lastRun').textContent = status.lastRun ? new Date(status.lastRun).toLocaleString('ko-KR') : 'ì—†ìŒ';

      if (status.lastResult) {
        if (status.lastResult.error) {
          document.getElementById('lastResult').textContent = 'âŒ ' + status.lastResult.error;
        } else {
          document.getElementById('lastResult').textContent =
            `âœ… ì„±ê³µ ${status.lastResult.success ?? 0}ê°œ / ì‹¤íŒ¨ ${status.lastResult.fail ?? 0}ê°œ`;
        }
      }

      document.getElementById('btnRun').disabled = status.running;

      // ì˜µì…˜
      document.getElementById('optN').value = options.trackNTotal;
      document.getElementById('optM').value = options.trackMPerCategory;
      document.getElementById('optX').value = options.dedupDays;
      document.getElementById('optDelay').value = options.analysisDelayMs;
    } catch (e) {}
  }

  async function loadCollected() {
    const wrap = document.getElementById('tableWrap');
    try {
      const res = await fetch('/api/collected');
      const { items } = await res.json();

      if (!items || items.length === 0) {
        wrap.innerHTML = '<div class="empty">ì•„ì§ ìˆ˜ì§‘ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const rows = items.map(item => {
        const r = item.f_reliability_score;
        const scoreClass = r >= 70 ? 'score-high' : r >= 40 ? 'score-mid' : 'score-low';
        const date = item.f_created_at ? new Date(item.f_created_at).toLocaleString('ko-KR') : 'â€”';
        const link = `https://aggrofilter.com/result/${item.f_video_id}`;
        return `
          <tr>
            <td class="title-cell"><a href="${link}" target="_blank">${escHtml(item.f_video_title || 'â€”')}</a></td>
            <td>${escHtml(item.f_channel_name || 'â€”')}</td>
            <td><span class="score ${scoreClass}">${r != null ? r + 'ì ' : 'â€”'}</span></td>
            <td>${item.f_clickbait_score != null ? item.f_clickbait_score + 'ì ' : 'â€”'}</td>
            <td style="color:#718096;font-size:11px">${date}</td>
          </tr>`;
      }).join('');

      wrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>ì˜ìƒ ì œëª©</th>
              <th>ì±„ë„ëª…</th>
              <th>ì‹ ë¢°ë„</th>
              <th>ì–´ê·¸ë¡œ</th>
              <th>ë¶„ì„ ì‹œê°</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    } catch (e) {
      wrap.innerHTML = `<div class="empty">ì˜¤ë¥˜: ${e.message}</div>`;
    }
  }

  async function saveOptions() {
    const body = {
      trackNTotal: document.getElementById('optN').value,
      trackMPerCategory: document.getElementById('optM').value,
      dedupDays: document.getElementById('optX').value,
      analysisDelayMs: document.getElementById('optDelay').value,
    };
    try {
      const res = await fetch('/api/options', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await res.json();
      showToast('ì˜µì…˜ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ok');
    } catch (e) {
      showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'err');
    }
  }

  async function runNow() {
    document.getElementById('btnRun').disabled = true;
    try {
      const res = await fetch('/api/run', { method: 'POST' });
      const data = await res.json();
      showToast(data.message, data.ok ? 'ok' : 'err');
      if (data.ok) {
        fetchStatus();
        // ì‹¤í–‰ ì¤‘ í´ë§
        pollingTimer = setInterval(() => {
          fetchStatus();
        }, 3000);
        setTimeout(() => { clearInterval(pollingTimer); loadCollected(); }, 60000);
      }
    } catch (e) {
      showToast('ì‹¤í–‰ ì˜¤ë¥˜: ' + e.message, 'err');
      document.getElementById('btnRun').disabled = false;
    }
  }

  function showToast(msg, type = '') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast show ' + type;
    setTimeout(() => { t.className = 'toast'; }, 3000);
  }

  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // ì´ˆê¸° ë¡œë“œ
  fetchStatus();
  loadCollected();
  setInterval(fetchStatus, 10000);
</script>
</body>
</html>
