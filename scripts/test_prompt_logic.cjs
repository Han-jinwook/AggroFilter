const { GoogleGenerativeAI } = require("@google/generative-ai");
const dotenv = require('dotenv');
const path = require('path');

// Load env vars
dotenv.config({ path: path.resolve(process.cwd(), '.env.local') });
dotenv.config({ path: path.resolve(process.cwd(), '.env') });

const apiKey = process.env.GOOGLE_API_KEY || process.env.GEMINI_API_KEY;

if (!apiKey) {
    console.error("âŒ API Key not found");
    process.exit(1);
}

const genAI = new GoogleGenerativeAI(apiKey);

async function testPrompt() {
    console.log("ğŸ§ª Testing AI Topic Generation Logic...");

    const model = genAI.getGenerativeModel({ 
      model: "gemini-2.5-flash",
      generationConfig: {
        temperature: 0.2,
        topP: 0.85,
      }
    });

    // Mock Data: A video about opening a Study Cafe (Micro subject) but really about Startup/Business (Macro theme)
    const channelName = "BizMan";
    const title = "ìŠ¤í„°ë””ì¹´í˜ ì°½ì—…, ì ˆëŒ€ í•˜ì§€ ë§ˆì„¸ìš”. 1ë…„ ìš´ì˜ ìˆ˜ìµ ê³µê°œí•©ë‹ˆë‹¤.";
    const transcript = `
        ì•ˆë…•í•˜ì„¸ìš”. ì˜¤ëŠ˜ì€ ì œê°€ ìŠ¤í„°ë””ì¹´í˜ë¥¼ 1ë…„ê°„ ìš´ì˜í•˜ë©´ì„œ ëŠë‚€ ì ì„ ì†”ì§í•˜ê²Œ ë§ì”€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.
        ë§ì€ ë¶„ë“¤ì´ ë¬´ì¸ ì°½ì—… ì•„ì´í…œìœ¼ë¡œ ìŠ¤í„°ë””ì¹´í˜ë¥¼ ê³ ë¯¼í•˜ì‹œëŠ”ë°ìš”.
        ì´ˆê¸° ì¸í…Œë¦¬ì–´ ë¹„ìš©ì´ í‰ë‹¹ 200ë§Œì› ì´ìƒ ë“¤ì–´ê°‘ë‹ˆë‹¤. 
        ê·¸ë¦¬ê³  ì „ê¸°ì„¸, ê´€ë¦¬ë¹„, í‚¤ì˜¤ìŠ¤í¬ ë Œíƒˆë¹„ ë“± ê³ ì • ì§€ì¶œì´ ë§Œë§Œì¹˜ ì•Šì•„ìš”.
        ìˆœìˆ˜ìµë¥ ì€ ìƒê°ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤. ì°¨ë¼ë¦¬ ê·¸ ëˆìœ¼ë¡œ ë¯¸êµ­ ì£¼ì‹ì„ ì‚¬ëŠ”ê²Œ ë‚˜ì„ ìˆ˜ë„ ìˆì–´ìš”.
        ìì˜ì—… ì‹œì¥ì´ ì •ë§ í¬í™”ìƒíƒœì…ë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ ê²°ì •í•˜ì…”ì•¼ í•©ë‹ˆë‹¤.
    `;

    // The NEW Prompt Logic (Copied from lib/gemini.ts to verify)
    const systemPrompt = `
    # ì–´ê·¸ë¡œí•„í„° ë¶„ì„ AIìš© í”„ë¡¬í”„íŠ¸ (ìœ íŠœë¸Œ ì˜ìƒ ì „ìš©)
    
    ## ì—­í• 
    ë„ˆëŠ” ìœ íŠœë¸Œ ì˜ìƒì˜ ì œëª©, ì¸ë„¤ì¼, ë³¸ë¬¸ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬, ì •í™•ì„±, ì–´ê·¸ë¡œì„±, ì‹ ë¢°ë„ ì ìˆ˜ë¥¼ ì‚°ì¶œí•˜ê³ , í‰ê°€ ê·¼ê±°ì™€ í•„ìš” ì‹œ ì°©í•œ ì œëª©ì„ ì œì•ˆí•˜ëŠ” ë¶„ì„ ì‹œìŠ¤í…œì´ë‹¤. ë¶„ì„ ê²°ê³¼ëŠ” í•­ìƒ ì½˜í…ì¸ ì˜ ì›ë˜ ì–¸ì–´ë¡œ ì‘ì„±í•˜ë©°, ê°™ì€ ì½˜í…ì¸ ëŠ” ì–¸ì œë‚˜ ì¼ê´€ëœ ê²°ê³¼ê°€ ë‚˜ì™€ì•¼ í•œë‹¤.
    
    ## ë¶„ì„ ê¸°ì¤€
    1. ì£¼ì œ ì„ ì • ê¸°ì¤€ (ë§¤ìš° ì¤‘ìš” - êµ¬ì²´ì  ì†Œì¬ê°€ ì•„ë‹Œ 'ë¶„ì•¼'ë¥¼ ì„ íƒí•  ê²ƒ)
    - ì½˜í…ì¸ ì˜ í•µì‹¬ ë‚´ìš©ì„ í¬ê´„í•˜ëŠ” **ê°€ì¥ ê±°ì‹œì ì´ê³  ì¼ë°˜ì ì¸ ì¹´í…Œê³ ë¦¬(ë¶„ì•¼)**ë¥¼ ì„ ì •í•˜ì‹œì˜¤.
    - **ë°˜ë“œì‹œ í•œê¸€ 2ë‹¨ì–´ (ëª…ì‚¬ + ëª…ì‚¬, í˜¹ì€ í˜•ìš©ì‚¬ + ëª…ì‚¬)** í˜•íƒœë¡œ ì‘ì„±í•  ê²ƒ.
    - **ì ˆëŒ€ ê¸ˆì§€**: êµ¬ì²´ì ì¸ ê³ ìœ ëª…ì‚¬(êµ­ê°€ëª…, ë¸Œëœë“œëª…, ì¸ë¬¼ëª… ë“±)ë‚˜ ë¯¸ì‹œì ì¸ ì†Œì¬ë¥¼ ì£¼ì œë¡œ ì‚¼ì§€ ë§ ê²ƒ.
      - (X) "ë² ë„¤ìˆ˜ì—˜ë¼ ì‚¬íƒœ", "ì•„ì´í° ë¦¬ë·°", "ì´ì¬ëª… ë°œì–¸", "ìŠ¤í„°ë””ì¹´í˜"
      - (O) "êµ­ì œ ì •ì„¸", "IT ê¸°ê¸°", "êµ­ë‚´ ì •ì¹˜", "ìì˜ì—… ì°½ì—…"
    - **ì°¸ê³  í‘œì¤€ ì£¼ì œì–´ ëª©ë¡** (ê°€ëŠ¥í•˜ë©´ ì•„ë˜ ëª©ë¡ì´ë‚˜ ì´ì™€ ìœ ì‚¬í•œ ìˆ˜ì¤€ì˜ ë‹¨ì–´ë¥¼ ì„ íƒí•˜ì‹œì˜¤):
      - [ì •ì¹˜/ì‚¬íšŒ]: êµ­ì œ ì •ì„¸, êµ­ë‚´ ì •ì¹˜, ì‹œì‚¬ ì´ìŠˆ, ì‚¬íšŒ ë¬¸ì œ, ì™¸êµ ì•ˆë³´, ë²•ë¥  ìƒì‹
      - [ê²½ì œ/ê¸ˆìœµ]: ì„¸ê³„ ê²½ì œ, ê²½ì œ ë¶„ì„, ì£¼ì‹ íˆ¬ì, ë¶€ë™ì‚°, ìƒí™œ ê²½ì œ, ì¬í…Œí¬
      - [ë¹„ì¦ˆë‹ˆìŠ¤]: ìì˜ì—…, ì°½ì—… ì •ë³´, ê¸°ì—… ê²½ì˜, ë§ˆì¼€íŒ…, ì„±ê³µ ë§ˆì¸ë“œ
      - [ê¸°ìˆ /ê³¼í•™]: IT ê¸°ìˆ , ê³¼í•™ ê¸°ìˆ , ë¯¸ë˜ ì‚°ì—…, AI íŠ¸ë Œë“œ
      - [ë¼ì´í”„]: ê±´ê°• ì •ë³´, ìê¸° ê°œë°œ, ì¸ê°„ ê´€ê³„, ì‹¬ë¦¬ ë¶„ì„
    - **[ì¤‘ìš”] ì„ ì •ëœ í•œê¸€ ì£¼ì œì˜ ì˜ë¬¸ ë²ˆì—­(topic_en)ë„ ë°˜ë“œì‹œ í•¨ê»˜ ë°˜í™˜í•  ê²ƒ.** (ì˜ˆ: "êµ­ì œ ì •ì„¸" -> "International Politics")
    
    2. ì •í™•ì„± í‰ê°€ ê¸°ì¤€
    - ì œëª©ê³¼ ë³¸ë¬¸ ë‚´ìš© ì¼ì¹˜ë„
    - ê´‘ê³ ì„± ì—¬ë¶€ íŒë‹¨ ë° ì§„ì‹¤ì„±
    - ê°ì •ì  í”„ë ˆì„, í¸í–¥ì  í•´ì„, ì™œê³¡ ì—¬ë¶€
    - ì¶œì²˜ ë° ì¸ìš© ë°ì´í„°ì˜ ê³µì‹ ë ¥
    - ì •í™•ì„±: 1~100ì  (ê·¼ê±° í•„ìˆ˜ ê¸°ì¬)
    
    3. ì–´ê·¸ë¡œì„± í‰ê°€ ê¸°ì¤€ (ë§¤ìš° ì¤‘ìš”: ìƒëŒ€ì  í‰ê°€ ë„ì…)
    - **í•µì‹¬ ì›ì¹™**: 'í¥ë¯¸ ìœ ë°œ(Hook)'ê³¼ 'ê¸°ë§Œ(Deception)'ì„ ì² ì €íˆ êµ¬ë¶„í•  ê²ƒ.
    - **ì°©í•œ ì–´ê·¸ë¡œ(Good Hook)**: ì œëª©ì´ í˜¸ê¸°ì‹¬ì„ ìê·¹í•˜ê±°ë‚˜ ê°•í•œ í‘œí˜„ì„ ì¼ë”ë¼ë„, ë³¸ë¬¸ ë‚´ìš©ì´ ê·¸ ì˜ë¬¸ì„ **ì¶©ì‹¤í•˜ê³  ì •í™•í•˜ê²Œ í•´ì†Œ**í•œë‹¤ë©´ ì´ëŠ” 'ë§ˆì¼€íŒ…ì  ìš”ì†Œ'ë¡œ ë³´ì•„ ì ìˆ˜ë¥¼ ë‚®ê²Œ ì±…ì •í•´ì•¼ í•œë‹¤ (ê¶Œì¥: 0~25%).
    - **ë‚˜ìœ ì–´ê·¸ë¡œ(Bad Clickbait)**: ì œëª©ì´ ì•½ì†í•œ ë‚´ìš©ì„ ë³¸ë¬¸ì—ì„œ ë‹¤ë£¨ì§€ ì•Šê±°ë‚˜, ê²°ë¡ ì„ ì§ˆì§ˆ ëŒê±°ë‚˜, ì „í˜€ ë‹¤ë¥¸ ë‚´ìš©ì„ ë‹¤ë£° ë•Œ ë†’ì€ ì ìˆ˜ë¥¼ ë¶€ì—¬í•œë‹¤.
    - **ì ìˆ˜ ë³´ì • ë¡œì§**: ë§Œì•½ **ì •í™•ì„± ì ìˆ˜ê°€ 80ì  ì´ìƒ**ì´ë¼ë©´, ë‹¨ìˆœí•œ 'ê¶ê¸ˆì¦ ìœ ë°œí˜• ì œëª©'ì´ë‚˜ 'ê°•ì¡°ëœ ì¸ë„¤ì¼'ì— ëŒ€í•œ ì–´ê·¸ë¡œì„± ì ìˆ˜ëŠ” **ì ˆë°˜ ì´í•˜ë¡œ ëŒ€í­ ê°ê²½**í•˜ë¼.
    - ì˜ˆì‹œ: "ì¶©ê²©ì ì¸ ì§„ì‹¤ ê³µê°œ"ë¼ëŠ” ì œëª©ì´ì§€ë§Œ ë‚´ìš©ì´ ê·¸ ì§„ì‹¤ì„ ëª…í™•í•˜ê³  ë…¼ë¦¬ì ìœ¼ë¡œ ì„¤ëª…í•¨ -> ì–´ê·¸ë¡œì„± 10~20%.
    - ì–´ê·¸ë¡œì„±: 1~100% (ê·¼ê±° í•„ìˆ˜ ê¸°ì¬)
    
    4. ì‹ ë¢°ë„ ì ìˆ˜ í™˜ì‚°
    - ê³„ì‚°ì‹: ì‹ ë¢°ë„ = (ì •í™•ì„± + (100 - ì–´ê·¸ë¡œì„±)) Ã· 2
    - ì‹ ë¢°ë„: 0~100ì 
    
    5. í‰ê°€ì´ìœ  ì‘ì„± ê¸°ì¤€
    - ì •í™•ì„±, ì–´ê·¸ë¡œì„±, ì‹ ë¢°ë„ ì ìˆ˜ë¥¼ ë¶€ì—¬í•œ ê·¼ê±°ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±
    - ìˆ¨ì€ ì˜ë„(ìƒì—…ì , ì •ì¹˜ì , ì—¬ë¡ ì¡°ì‘ ë“±)ê°€ ìˆë‹¤ë©´ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨í•´ ì„¤ëª…
    - ì¹œê·¼í•˜ê³  ìì—°ìŠ¤ëŸ¬ìš´ ì–´íˆ¬ë¡œ ì‘ì„±
    - **í‰ê°€ì´ìœ  ì´í‰ì— ì‹ ë¢°ë„ ì ìˆ˜ì— ë”°ë¥¸ ì‹ í˜¸ë“± ìƒ‰ìƒê³¼ ì˜ë¯¸(ì•ˆì‹¬, ì£¼ì˜, ê²½ê³ )ë¥¼ ë°˜ë“œì‹œ í¬í•¨**
    - ì‹ ë¢°ë„ 70ì  ì´ìƒ: ë…¹ìƒ‰ë¶ˆ (ì•ˆì‹¬)
    - ì‹ ë¢°ë„ 50~69ì : ë…¸ë€ë¶ˆ (ì£¼ì˜)
    - ì‹ ë¢°ë„ 50ì  ë¯¸ë§Œ: ë¹¨ê°„ë¶ˆ (ê²½ê³ )
    
    6. ì¶”ì²œ ì œëª© ìƒì„± ê¸°ì¤€
    - ì–´ê·¸ë¡œì„±ì´ 30% ì´ìƒì¼ ê²½ìš°, ê°ì •ì /ê³¼ì¥ì  ìš”ì†Œ ì œê±° í›„ ë‚´ìš©ì„ ì •í™•íˆ ë°˜ì˜í•œ ì¬ë¯¸ë„ ê°€ë¯¸ëœ ì°©í•˜ê³  í•©ë¦¬ì ì¸ ì œëª© ì¶”ì²œ
    
    ## ì…ë ¥ ë°ì´í„°
    - ì±„ë„ëª…: ${channelName}
    - ì œëª©: ${title}
    - ë‚´ìš©(ìë§‰): ${transcript}
    
    ## ì¶œë ¥ í˜•ì‹ (JSON Only)
    ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ë¼. ë§ˆí¬ë‹¤ìš´ í¬ë§·íŒ…(\`\`\`json)ì„ í¬í•¨í•˜ì§€ ë§ ê²ƒ.
    
    {
      "topic": "í•œê¸€ ì£¼ì œ (2ë‹¨ì–´ ì´ë‚´)",
      "topic_en": "English Translation of topic (Essential for vector search)",
      "accuracy": 0-100 (ì •ìˆ˜),
      "clickbait": 0-100 (ì •ìˆ˜),
      "reliability": 0-100 (ì •ìˆ˜),
      "subtitleSummary": "ì‹œê°„ìˆœ ì±•í„°ë³„ ì£¼ìš” ë‚´ìš© ìš”ì•½ (ìƒì„¸í•˜ê²Œ)",
      "evaluationReason": "ì ìˆ˜ ë¶€ì—¬ ê·¼ê±° ë° ìˆ¨ì€ ì˜ë„ ìƒì„¸ ì„œìˆ . ì´í‰(ì‹ í˜¸ë“± ë“±ê¸‰ í¬í•¨) í•„ìˆ˜.",
      "overallAssessment": "ì „ë°˜ì ì¸ í‰ê°€ ë° ì‹œì²­ì ìœ ì˜ì‚¬í•­",
      "recommendedTitle": "ì–´ê·¸ë¡œì„± 30% ì´ìƒì¼ ë•Œë§Œ ì¶”ì²œ ì œëª© (ì•„ë‹ˆë©´ ë¹ˆ ë¬¸ìì—´)"
    }
    `;

    try {
        const result = await model.generateContent(systemPrompt);
        const response = result.response;
        const text = response.text();
        console.log("\nRaw Output:\n" + text);
        
        const jsonStr = text.replace(/```json\n|\n```/g, "").replace(/```/g, "").trim();
        const data = JSON.parse(jsonStr);

        console.log("\n---------------------------------------------------");
        console.log("âœ… Analysis Result:");
        console.log(`   - Input Title: "${title}"`);
        console.log(`   - Generated Topic (KR): "${data.topic}"`);
        console.log(`   - Generated Topic (EN): "${data.topic_en}"`);
        console.log(`   - Evaluation Reason: ${data.evaluationReason.substring(0, 100)}...`);
        console.log("---------------------------------------------------");

        if (data.topic === "ìŠ¤í„°ë””ì¹´í˜" || data.topic.includes("ìŠ¤í„°ë””")) {
            console.log("âŒ Test Failed: Still returning micro-topic 'Study Cafe'");
        } else {
            console.log("ğŸ‰ Test Passed: Returns a macro-topic!");
        }

    } catch (e) {
        console.error("Error:", e);
    }
}

testPrompt();
